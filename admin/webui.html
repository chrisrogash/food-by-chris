<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recipe Admin Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: url("../static/images/background_home.jpg") no-repeat center center fixed;
        background-size: cover;
      }
    </style>
  </head>
  <body class="text-white position-relative min-vh-100 d-flex justify-content-center align-items-center">
    <div class="container mt-4 bg-dark rounded-5 border border-3 p-4">
      <h1 class="display-5 fw-bold mb-4">Recipe Admin Portal</h1>
        
      <form id="recipeForm" class="needs-validation" novalidate>
        <label>ID</label>
            <div class="input-group mb-3">
                <input id="id" name="id" class="form-control bg-dark text-white" value="{{ next_prefix }}_" readonly/>
            </div>
        
        <label>Name</label>
            <div class="input-group mb-3">
                <div class="input-group-text">{{ next_prefix }}</div>
                <input id="name" name="name" class="form-control" required/>
            </div>

        <div class="mb-3">
            <label class="form-label">Tags</label>
                <div class="d-flex flex-wrap gap-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="gluten_free" id="tag_gluten" name="tags">
                        <label class="form-check-label px-2 rounded bg-danger text-white" for="tag_gluten">Gluten Free</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="dairy_free" id="tag_dairy" name="tags">
                        <label class="form-check-label px-2 rounded bg-warning text-dark" for="tag_dairy">Dairy Free</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="nut_free" id="tag_nut" name="tags">
                        <label class="form-check-label px-2 rounded bg-success text-white" for="tag_nut">Nut Free</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="low_fructose" id="tag_fructose" name="tags">
                        <label class="form-check-label px-2 rounded bg-info text-dark" for="tag_fructose">Low Fructose</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="vegan" id="tag_vegan" name="tags">
                        <label class="form-check-label px-2 rounded bg-primary text-white" for="tag_vegan">Vegan</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="vegetarian" id="tag_vegetarian" name="tags">
                        <label class="form-check-label px-2 rounded bg-secondary text-white" for="tag_vegetarian">Vegetarian</label>
                    </div>
                </div>
            </div>


        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="prep_time" class="form-label">Prep time (min)</label>
            <input id="prep_time" name="prep_time" class="form-control" type="number" min="0" />
          </div>
          <div class="col-md-6 mb-3">
            <label for="cook_time" class="form-label">Cook time (min)</label>
            <input id="cook_time" name="cook_time" class="form-control" type="number" min="0" />
          </div>
        </div>

        <div class="mb-3">
          <label for="ingredients" class="form-label">Ingredients (qty,name per line)</label>
          <textarea id="ingredients" name="ingredients" class="form-control" rows="5"></textarea>
        </div>

        <div class="mb-3">
          <label for="instructions" class="form-label">Instructions (one per line)</label>
          <textarea id="instructions" name="instructions" class="form-control" rows="5"></textarea>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Notes (one per line)</label>
          <textarea id="notes" name="notes" class="form-control" rows="5"></textarea>
        </div>

        <div class="mb-3">
            <label for="image" class="form-label">Upload image (jpg only)</label>
            <input id="image" name="image" class="form-control" type="file" accept=".jpg,image/jpeg" />
        </div>

        <button type="button" onclick="generate()" class="btn btn-outline-light" title="Generate a single json file, you need to refresh the page after this">Generate JSON</button>
        <button type="button" id="generateHtmlBtn" class="btn btn-outline-light" title="Converts all the JSON Recipes to HTML files, only need to do this once after recipes have been JSONified">Generate HTML's</button>
        <button type="button" id="syncToGithubBtn" class="btn btn-outline-light" title="Sync's all folders to Github, all recipe's should now be live!">Sync to Github</button>
      </form>

      <pre id="output" class="bg-black text-white mt-4 p-3 rounded"></pre>
    </div>

<script>
  const prefix = "{{ next_prefix }}";
  const idInput = document.getElementById('id');
  const nameInput = document.getElementById('name');

  // Auto-update ID as name changes
  nameInput.addEventListener('input', () => {
    const formatted = nameInput.value.trim()
      .replace(/[^a-zA-Z0-9 ]+/g, '')
      .replace(/\s+/g, '_');
    idInput.value = prefix + "_" + formatted;
  });

  async function generate() {
    const form = document.getElementById('recipeForm');
    const formData = new FormData(form);

    // add combined tags manually
    const checkedTags = Array.from(form.querySelectorAll('input[name="tags"]:checked')).map(i => i.value);
    formData.delete('tags');
    checkedTags.forEach(tag => formData.append('tags', tag));

    const res = await fetch('/generate', {
      method: 'POST',
      body: formData
    });

    const result = await res.json();
    if (result.error) {
      alert(result.error);
      return;
    }

    document.getElementById('output').textContent =
      JSON.stringify(result, null, 2);
  }

  document.getElementById('generateHtmlBtn').addEventListener('click', async () => {
    const res = await fetch('/generate_html', { method: 'POST' });
    const result = await res.text();
    document.getElementById('output').textContent = result;
  });

  document.getElementById("syncToGithubBtn").addEventListener("click", async () => {
    const res = await fetch("/sync", { method: "POST" });
    const result = await res.json();
    document.getElementById("output").textContent = JSON.stringify(result, null, 2);
  });
</script>

  </body>
</html>
